# AWS Instance Scheduler

## Solution Overview
https://aws.amazon.com/solutions/instance-scheduler/

Amazon Web Services (AWS) offers cloud resource on demand so that customers can control their resource capacity and pay as you go. One approach to reduce costs is to stop resources that are not in use, and start those resources when their capacity is needed.

The AWS Instance Scheduler is a solution that enables customers to easily configure custom start and stop schedules and automates the starting (when resources capacity is needed) and stopping
(resources that are not in use) of Amazon Elastic Compute Cloud (Amazon EC2) and Amazon Relational Database Service (Amazon RDS) instances.

The Instance Scheduler leverages AWS resource tags and AWS Lambda function to automatically stop and restart instances across multiple AWS Regions and accounts on a customer-defined schedule which stored in Amazon DynamoDB. An Amazon CloudWatch event triggers an AWS Lambda function that checks the current state of each appropriately tagged instance and execute the action based on schedule.

The Lambda function also records the name of the schedule, the instances associated with that schedule, and the status of instances in Amazon DynamoDB.

## The solution architecture
![](resource/images/instance-scheduler-architecture.png)

Scheduler for EC2 and RDS instances start and stop based on plan. The solutions support Cross-Account and Cross-Region scheduling.
This repo is forked from https://github.com/awslabs/aws-instance-scheduler and made update for china region based on v1.3.0 version. 

## Getting Startedï¼š

Refer below document to create cloudformation stack and execute demo testing 

[How to deploy cloudformation and execute demo testing](Testing.md)


## Build from Source
- If you want to build your own instance-scheduler from source and deploy solutions
- If you plan to modify this solution and add your customized content, you can deploy it through the new Cloudformation template and related resources which generated by Makefile.

Customized build and deployment include the following:
1. Generate the new AWS Instance Scheduler Cloudformation template
2. Package the new Lambda function code of AWS Instance Scheduler
3. Upload the new artifacts to user specified S3 bucket.

The project building script is located at deployment/build-s3-dist.sh. You should NOT modify the structure of the project, but you can add new code or modify existed code.

The following are some key components:
- deployment/: This folder hosts build script, unit test script and CloudFormation templates.
- deployment/build-s3-dist.sh: The script to replace variables in CloudFormation template and build source code zip file
- deployment/run-unit-tests.sh: Unit test script.
- source/: source code and test code folders


The basic steps are as follows, the setup commands have been verified on Amazon Linux, Ubuntu, MacOS:

1. You can git clone this repo

```bash
# git clone
git clone https://code.awsrun.com/csdc/aws-instance-scheduler.git
cd aws-instance-scheduler/source/code/
```

2. Make sure the aws cli, pip, zip command and pytz liberary have been installed on your machine

```bash
# Install pytz
pip install pytz
pytz_location=$(pip show pytz | grep Location | cut -d':' -f 2 | tr -d " ")
cp -r ${pytz_location}/pytz .
```

3. Modify the code to add your content

4. Running Unit Tests

```bash
cd ../../deployment/
chmod +x run-unit-tests.sh && ./run-unit-tests.sh
```

5. Run build-s3-dist.sh to build the project

```bash
# Build
## define variable or specify the value of bucket, solution, version, final_bucket
## The solution will append the [region] to [bucket], using [bucket]-[region] as the final S3 bucket name final_bucket. 
## Lambda code will located into region specific S3 bucket final_bucket.
## Please make sure the final_bucket=[bucket]-[region] name unique
export bucket=YOUR_S3_BUCKET_BASE_NAME 
export solution=THE_SOLUTION_NAMING
export version=THE_VERSION
export region=THE_REGION_OF_S3_BUCKET_LOCATED
export final_bucket=${bucket}-${region}
chmod +x build-s3-dist.sh && ./build-s3-dist.sh ${final_bucket} ${bucket} ${solution} ${version}
## for example: ./build-s3-dist.sh solutions-scheduler-cn-northwest-1 solutions-scheduler aws-instance-scheduler v1.3.0


# set s3 bucket PublicAccessBlock configuration, make sure you use upgrade your aws cli > 1.18
aws s3api put-public-access-block --bucket ${final_bucket} \
    --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true" --region ${region}

# Upload the Cloudformation template and related source code
chmod +x deploy-dist.sh && ./deploy-dist.sh ${final_bucket} ${bucket} ${solution} ${version} ${region}
# for example: ./deployment/deploy-dist.sh solutions-scheduler-cn-northwest-1 solutions-scheduler aws-instance-scheduler v1.3.0 cn-northwest-1

# Delete pytz
cd ../source/code/
rm -r pytz/
cd ../..
```

## What's result the build and deploy successfully excuted? 
- A new S3 bucket ${final_bucket} will be automatically created if it is not existed
- The resources will be automatically uploaded to s3://${final_bucket}/${solution}/${version}/
- The S3 bucket public access block policy as: BlockPublicAcls=false,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

***

Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.

Licensed under the Apache License Version 2.0 (the "License"). You may not use this file except in compliance with the License. A copy of the License is located at

    http://www.apache.org/licenses/

or in the "license" file accompanying this file. This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions and limitations under the License.
